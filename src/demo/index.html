<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>demo subdomain</title>
    <link rel="stylesheet" href="../demo/dev.thatako-council.css">
</head>

<body>
    <div class="container">
        <h1>id.thatako.net</h1>
        <div class="subtitle">free subdomains for projects & devs</div>

        <!-- 1: login -->
        <div class="step active" id="step-login">
            <div class="card">
                <h2>01 - authenticate</h2>
                <p style="font-size:0.82rem;color:#888;margin-bottom:16px;line-height:1.6">
                    sign in with GitHub to claim your free subdomain<br>
                    your identity is used to verify ownership when making changes
                </p>
                <div class="subdomain-row">
                    <input type="text" id="subdomain-input" placeholder="yourname"
                        oninput="validateSubdomain(this.value)" />
                    <span>.id.thatako.net</span>
                </div>
                <button id="btn-login" onclick="startLogin()">Login with GitHub →</button>
            </div>
        </div>

        <!-- 2: register -->
        <div class="step" id="step-register">
            <div class="card">
                <h2>02 - identity</h2>
                <div class="user-badge">
                    <img id="user-avatar" src="" alt="avatar" />
                    <div>
                        <div class="name" id="user-name">-</div>
                        <div class="id" id="user-id-display">github ID: -</div>
                    </div>
                </div>
                <button class="btn-secondary" onclick="logout()">← Switch account</button>
            </div>

            <div class="card">
                <h2>03 - subdomain</h2>
                <label>Your subdomain!</label>
                <div class="subdomain-row">
                    <input type="text" id="subdomain-input" placeholder="yourname"
                        oninput="validateSubdomain(this.value)" />
                    <span>.id.thatako.net</span>
                </div>
                <div class="status" id="subdomain-status"></div>

                <label style="margin-top:4px">contact email (optional)</label>
                <input type="email" id="email-input" placeholder="you@example.com" />
            </div>

            <div class="card">
                <h2>04 - hosting</h2>
                <label>Platform</label>
                <select id="host-select" onchange="updateRecordDefaults(this.value)">
                    <option value="vercel">Vercel</option>
                    <option value="github-pages">GitHub pages</option>
                    <option value="custom">Other</option>
                </select>

                <label>DNS Records</label>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Value</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="records-body"></tbody>
                </table>
                <div class="add-record-row">
                    <select id="new-record-type" onchange="toggleNameField(this.value)">
                        <option>A</option>
                        <option>AAAA</option>
                        <option>CNAME</option>
                        <option>TXT</option>
                        <option>MX</option>
                    </select>
                    <input type="text" id="new-record-name" placeholder="name" style="display:none" />
                    <input type="text" id="new-record-value" placeholder="value" />
                    <button onclick="addRecord()">+ add</button>
                </div>
                <p style="font-size:0.72rem;color:#555;margin-top:6px">name = host label from your provider (e.g.
                    <code>aitji.id</code> for a CNAME)</p>
            </div>

            <div class="card">
                <h2>05 - co-owners (optional)</h2>
                <p style="font-size:0.78rem;color:#666;margin-bottom:12px">
                    additional [GitHub] users who can edit this domain.
                </p>
                <div class="owner-list" id="owner-list"></div>
                <div class="add-owner-row">
                    <input type="text" id="new-owner-input" placeholder="github username" />
                    <button onclick="addOwner()">+ Add</button>
                </div>
                <div class="status" id="owner-status"></div>
            </div>

            <div class="card">
                <h2>06 - confirm</h2>
                <p class="warning">
                    by registering ; you agree this subdomain will point to your project<br>
                    misuse (NSFW, impersonation, phishing) will result in removal
                </p>
                <pre id="preview-json" style="margin-top:12px">{ ... fill in fields above ... }</pre>
                <button id="btn-register" onclick="submitRegistration()" disabled>Register subdomain →</button>
                <div class="status" id="register-status"></div>
            </div>
        </div>

        <!-- 3: done -->
        <div class="step" id="step-done">
            <div class="card">
                <h2>registered ✓</h2>
                <p id="done-msg" style="font-size:0.85rem;color:#888;line-height:1.6"></p>
                <pre id="done-json"></pre>
                <button class="btn-secondary" onclick="reset()" style="margin-top:12px">Register another →</button>
            </div>
        </div>

    </div>

    <script>
        const WORKER_URL = 'https://workers.thatako.net'
        const AUTH_URL = '/api/auth'
        const CALLBACK = '/api/callback'

        // state
        let user = null // { login, id, avatar_url, email? }
        let sig = null // HMAC signature from server
        let userData = null // raw data string signed
        let records = []
        let owners = []

        // types that need a name field (host label from provider)
        const NAME_TYPES = new Set(['CNAME', 'MX'])

        const DEFAULT_RECORDS = {
            vercel: [
                { type: 'A', name: '', value: '76.76.21.21' },
                { type: 'CNAME', name: '', value: '' },
                { type: 'TXT', name: '', value: '' },
            ],
            'github-pages': [{ type: 'CNAME', name: '', value: 'your-user.github.io' }],
            custom: [],
        }

        // auth
        function startLogin() {
            sessionStorage.setItem('oauth_return', window.location.href)
            window.location.href = AUTH_URL + '?return=' + encodeURIComponent(window.location.href)
        }

        function logout() {
            user = null
            sig = null
            userData = null
            sessionStorage.removeItem('auth')
            showStep('step-login')
        }

        async function checkCallback() {
            const params = new URLSearchParams(window.location.search)
            const code = params.get('code')
            if (!code) {
                // check stored session
                const stored = sessionStorage.getItem('auth')
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored)
                        user = parsed.user
                        sig = parsed.sig
                        userData = parsed.userData
                        applyUser()
                    } catch { }
                }
                return
            }

            // exchange code via /api/callback
            showStatus('register-status', 'Authenticating...', 'info')
            try {
                const res = await fetch(`${CALLBACK}?code=${code}`)
                const json = await res.json()
                if (!res.ok) throw new Error(json.error || 'Auth failed')
                user = json.user
                sig = json.sig
                userData = json.userData
                sessionStorage.setItem('auth', JSON.stringify({ user, sig, userData }))

                // clean URL
                window.history.replaceState({}, '', window.location.pathname)
                applyUser()
            } catch (e) {
                showStatus('register-status', e.message, 'err')
            }
        }

        function applyUser() {
            document.getElementById('user-avatar').src = user.avatar_url
            document.getElementById('user-name').textContent = '@' + user.login
            document.getElementById('user-id-display').textContent = 'GitHub ID: ' + user.id
            document.getElementById('subdomain-input').value = user.login.toLowerCase()
            updateRecordDefaults(document.getElementById('host-select').value)
            validateSubdomain(user.login.toLowerCase())
            showStep('step-register')
        }

        // subdomain
        const DISALLOWED = ['www', 'mail', 'ftp', 'admin', 'api', 'dashboard', 'help', 'support', 'blog', 'status', 'cdn', 'static', 'assets', 'img', 'images', 'ns1', 'ns2', 'smtp', 'pop', 'imap', "go"]

        function validateSubdomain(val) {
            const el = document.getElementById('subdomain-status')
            const btn = document.getElementById('btn-register')
            if (!val) {
                el.style.display = 'none'
                btn.disabled = true
                return
            }

            if (!/^[a-z0-9][a-z0-9\-]{0,61}[a-z0-9]$|^[a-z0-9]$/.test(val)) {
                showStatus('subdomain-status', 'Invalid: lowercase letters, numbers, hyphens only', 'err')
                btn.disabled = true
                return
            }

            if (DISALLOWED.includes(val)) {
                showStatus('subdomain-status', 'That name is reserved', 'err')
                btn.disabled = true
                return
            }

            showStatus('subdomain-status', val + '.id.thatako.net - looks good', 'ok')
            btn.disabled = false
            updatePreview()
        }

        // record
        function toggleNameField(type) {
            const el = document.getElementById('new-record-name')
            el.style.display = NAME_TYPES.has(type) ? '' : 'none'
        }

        function updateRecordDefaults(host) {
            records = [...(DEFAULT_RECORDS[host] || [])]
            renderRecords()
            updatePreview()
        }

        function renderRecords() {
            const tbody = document.getElementById('records-body')
            tbody.innerHTML = records.map((r, i) => {
                const nameCell = NAME_TYPES.has(r.type)
                    ? `<td><input value="${escHtml(r.name || '')}" placeholder="name" oninput="records[${i}].name=this.value;updatePreview()" /></td>`
                    : `<td style="color:#555;font-size:0.75rem">(subdomain)</td>`
                return `<tr>
                    <td>${r.type}</td>
                    ${nameCell}
                    <td><input value="${escHtml(r.value)}" placeholder="value" oninput="records[${i}].value=this.value;updatePreview()" /></td>
                    <td><button onclick="removeRecord(${i})">✕</button></td>
                </tr>`
            }).join('')
        }

        function addRecord() {
            const type = document.getElementById('new-record-type').value
            const name = document.getElementById('new-record-name').value.trim()
            const value = document.getElementById('new-record-value').value.trim()
            if (!value) return
            records.push({ type, name: NAME_TYPES.has(type) ? name : '', value })
            document.getElementById('new-record-name').value = ''
            document.getElementById('new-record-value').value = ''
            renderRecords()
            updatePreview()
        }

        function removeRecord(i) {
            records.splice(i, 1)
            renderRecords()
            updatePreview()
        }

        // owners
        function renderOwners() {
            const el = document.getElementById('owner-list')
            el.innerHTML = owners.map((o, i) => `
            <div class="owner-item">
                <span>@${escHtml(o.login)} <span style="color:#555">· id:${o.id}</span></span>
                <button onclick="removeOwner(${i})">✕</button>
            </div>`).join('')
        }

        async function addOwner() {
            const input = document.getElementById('new-owner-input')
            const username = input.value.trim().replace(/^@/, '')
            if (!username) return
            if (owners.find(o => o.login === username)) {
                showStatus('owner-status', 'Already added', 'info')
                return
            }

            showStatus('owner-status', 'Looking up...', 'info')
            try {
                const res = await fetch(`https://api.github.com/users/${username}`)
                if (!res.ok) throw new Error('GitHub user not found')
                const gh = await res.json()
                owners.push({ login: gh.login, id: gh.id })
                input.value = ''
                renderOwners()
                updatePreview()
                showStatus('owner-status', '', 'info')
                document.getElementById('owner-status').style.display = 'none'
            } catch (e) {
                // might hit rate limit but whatever
                showStatus('owner-status', e.message, 'err')
            }
        }

        function removeOwner(i) {
            owners.splice(i, 1)
            renderOwners()
            updatePreview()
        }

        // preview
        function buildPayload() {
            const sub = document.getElementById('subdomain-input').value.trim()
            const email = document.getElementById('email-input').value.trim()
            const host = document.getElementById('host-select').value

            // records object
            const recordsObj = {}
            records.forEach(r => {
                if (!r.value) return // skip empty rows
                if (NAME_TYPES.has(r.type)) {
                    if (!recordsObj[r.type]) recordsObj[r.type] = []
                    recordsObj[r.type].push(r.name ? { name: r.name, value: r.value } : { value: r.value })
                } else if (r.type === 'TXT') {
                    recordsObj['TXT'] = r.value // single string
                } else {
                    if (!recordsObj[r.type]) recordsObj[r.type] = []
                    recordsObj[r.type].push(r.value)
                }
            })

            const ownerEntry = { github: user?.login || '', 'github-id': user?.id || 0 }
            if (email) ownerEntry.email = email

            const allOwners = [ownerEntry, ...owners.map(o => ({ github: o.login, 'github-id': o.id }))]

            return {
                domain: `${sub}.id.thatako.net`,
                host: [host],
                owner: allOwners,
                records: recordsObj,
            }
        }

        function updatePreview() {
            const el = document.getElementById('preview-json')
            if (!user) return
            el.textContent = JSON.stringify(buildPayload(), null, 2)
        }

        // submit
        async function submitRegistration() {
            if (!user || !sig) {
                showStatus('register-status', 'Not authenticated', 'err')
                return
            }
            const sub = document.getElementById('subdomain-input').value.trim()
            if (!sub) return

            const payload = buildPayload()
            showStatus('register-status', 'Submitting...', 'info')
            document.getElementById('btn-register').disabled = true

            try {
                const res = await fetch(`${WORKER_URL}/dns`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload, userData, sig }),
                })
                const json = await res.json()
                if (!res.ok) throw new Error(json.error || 'Worker error')

                document.getElementById('done-msg').textContent =
                    `${payload.domain} has been registered! DNS propagation may take a few minutes. ` +
                    `you can manage your subdomain via PR at github.com/aitji/id.thatako.net`

                document.getElementById('done-json').textContent = JSON.stringify(payload, null, 2)
                showStep('step-done')
            } catch (e) {
                showStatus('register-status', e.message, 'err')
                document.getElementById('btn-register').disabled = false
            }
        }

        // utils
        function showStep(id) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'))
            document.getElementById(id).classList.add('active')
        }

        function showStatus(id, msg, type) {
            const el = document.getElementById(id)
            el.textContent = msg
            el.className = 'status ' + type
            el.style.display = msg ? 'block' : 'none'
        }

        function escHtml(s) {
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        }

        function reset() {
            records = []
            owners = []
            showStep('step-login')

            // keep auth, just reset form
            if (user) {
                updateRecordDefaults('vercel')
                showStep('step-register')
            }
        }

        // boot
        checkCallback()
    </script>
</body>

</html>